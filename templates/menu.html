{% extends "base.html" %}
{% block title %}–ú–µ–Ω—é{% endblock %}

{% block content %}
{% macro resource_img(name) %}
    {% set mapping = {
        "–û—Å—Ç–∞—Ç–∫–∏ –ø—Å–∏-–º–∞—è—á–∫–∞": "psi",
        "–†—ã–∂–∏–π –ø–∞–ø–æ—Ä–æ—Ç–Ω–∏–∫": "papor",
        "–§—Ä–∞–≥–º–µ–Ω—Ç –¥–∞–Ω–Ω—ã—Ö \"–ì–∞–º–º–∞\"": "gamma",
        "–í–µ—â–µ—Å—Ç–≤–æ 07270": "07270",
        "–ö–≤–∞–Ω—Ç–æ–≤–∞—è –±–∞—Ç–∞—Ä–µ—è": "quant",
        "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è —Å—ã–≤–æ—Ä–æ—Ç–∫–∞": "vorot",
        "–õ–∏–º–±–æ–ø–ª–∞–∑–º–∞": "limbo",
        "–ì–æ—Ä—å–∫–æ–ª–∏—Å—Ç–Ω–∏–∫": "gorko",
        "–õ–∏–º–±": "limb",
        "–§—Ä–∞–≥–º–µ–Ω—Ç –¥–∞–Ω–Ω—ã—Ö \"–õ—è–º–±–¥–∞\"": "lamda",
        "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è": "batarey"
    } %}
    <img src="/static/img/resources/{{ mapping[name] }}.webp" class="resource-icon">
{% endmacro %}

<div class="main-container">
    <div class="content">
        <h1>{{ user.nick }}</h1>
        <div id="generalData" class="general-data-container">
            <div class="bp-container">
                <p>BP —É—Ä–æ–≤–µ–Ω—å: {{ user.bp_level }}</p>
                <p>BP –æ–ø—ã—Ç: {{ user.bp_exp }}/1000</p>
            </div>
            <p>–î–µ–Ω—å–≥–∏: {{ user.money }}</p>
        </div>
        <button id="editBtn">–ò–∑–º–µ–Ω–∏—Ç—å</button>

        <h2>–°–µ–≤–µ—Ä</h2>
        <div class="resource-list" id="northList">
            {% for name, value in user.north.items() %}
            <div class="resource-item">
                <div class="resource-image">
                    {{ resource_img(name) }}
                    <div class="image-count">{{ value }}x</div>
                </div>
                <div class="resource-name">{{ name }}</div>
            </div>
            {% endfor %}
        </div>

        <h2>–õ–∏–º</h2>
        <div class="resource-list" id="limList">
            {% for name, value in user.lim.items() %}
            <div class="resource-item">
                <div class="resource-image">
                    {{ resource_img(name) }}
                    <div class="image-count">{{ value }}x</div>
                </div>
                <div class="resource-name">{{ name }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="sidebar">
        <div class="menu-item"><a href="/profile" style="color:inherit;text-decoration:none;">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a></div>
        <div class="menu-item">‚öô –ú–µ–Ω—é</div>
        <a href="/past" class="menu-item">üìÖ –ü—Ä–æ—à–ª–æ–µ</a>
        <form action="/logout" method="get" style="margin:0;">
            <button type="submit" class="menu-item">üö™ –í—ã—Ö–æ–¥</button>
        </form>
    </div>
</div>

<script>
    const socket = new WebSocket(`ws://${location.host}/ws`);
    const editBtn = document.getElementById("editBtn");
    let editMode = false;

    editBtn.addEventListener("click", () => {
        if (!editMode) {
            editMode = true;
            editBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
            makeEditable();
        } else {
            saveChanges();
            editMode = false;
            editBtn.textContent = "–ò–∑–º–µ–Ω–∏—Ç—å";
            makeView();
        }
    });

    function makeEditable() {
        document.getElementById("generalData").innerHTML = `
            <div class="bp-container">
                <label>BP —É—Ä–æ–≤–µ–Ω—å:</label>
                <input type="number" id="bp_level" value="{{ user.bp_level }}">
                <label>BP –æ–ø—ã—Ç:</label>
                <input type="number" id="bp_exp" value="{{ user.bp_exp }}"> / 1000
            </div>
            <div>
                <label>–î–µ–Ω—å–≥–∏:</label>
                <input type="number" id="money" value="{{ user.money }}">
            </div>
        `;
        const northList = document.getElementById("northList");
        northList.innerHTML = `{% for name, value in user.north.items() %}
            <div class="resource-item">
                <div class="resource-image">
                    {{ resource_img(name) }}
                    <div class="image-count">{{ value }}x</div>
                </div>
                <div class="resource-name">{{ name }}</div>
                <input type="number" name="north_{{ name }}" value="{{ value }}">
            </div>
        {% endfor %}`;
        const limList = document.getElementById("limList");
        limList.innerHTML = `{% for name, value in user.lim.items() %}
            <div class="resource-item">
                <div class="resource-image">
                    {{ resource_img(name) }}
                    <div class="image-count">{{ value }}x</div>
                </div>
                <div class="resource-name">{{ name }}</div>
                <input type="number" name="lim_{{ name }}" value="{{ value }}">
            </div>
        {% endfor %}`;
    }

    function makeView() {
        location.reload();
    }

    function saveChanges() {
        const data = {north:{}, lim:{}};
        data.money = parseInt(document.getElementById("money").value);
        data.bp_level = parseInt(document.getElementById("bp_level").value);
        data.bp_exp = parseInt(document.getElementById("bp_exp").value);
        document.querySelectorAll('input[name^="north_"]').forEach(input => {
            data.north[input.name.replace("north_", "")] = parseInt(input.value);
        });
        document.querySelectorAll('input[name^="lim_"]').forEach(input => {
            data.lim[input.name.replace("lim_", "")] = parseInt(input.value);
        });
        socket.send(JSON.stringify(data));
    }
</script>
{% endblock %}
